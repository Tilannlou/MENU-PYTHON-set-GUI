# 🏗️ MENU002 系統架構設計

## 📋 概述

MENU002 是一個**領域特定語言 (DSL)**，專門用於GUI應用開發。它從簡單的腳本語言進化為完整的AI桌面助手系統。本文檔詳細說明了系統的架構設計、語言規格和模組劃分。

## 🎯 核心設計理念

### **DSL (Domain Specific Language) 設計**
MENU002 不是通用程式語言，而是專門針對GUI開發優化的**領域特定語言**：

- **聲明式語法**: 用`menu 指令 參數`的統一格式描述UI
- **抽象層次**: 隱藏Tkinter複雜性，提供直觀的GUI建構方式
- **事件驅動**: 支援互動式應用開發
- **參數化設計**: 統一的參數系統，跨指令共用
- **擴展性**: 支持插件和自定義指令

### **技術選型決策**
DSL實現語言的權衡考量：

- **實現難度**: MENU聲明式語法容易實現，Python動態特性加速開發
- **移植難度**: Python代碼難以移植到其他語言，接受"實現容易但移植難"的權衡
- **生態系統**: Python豐富的庫和工具鏈支持快速原型開發
- **性能平衡**: 優先功能完整性，後續可設計中間表示層便於跨語言移植

**決策**: 以開發效率和功能完整性為優先，未來可通過中間表示層解決移植性問題。

### **語言演進路徑**
```
組合語言 → 高階語言 → DSL (MENU002) → AI驅動框架
   ↓          ↓          ↓              ↓
硬件操作   通用抽象   領域優化       智能系統
```

## 🏛️ 當前架構 (v2.1.0)

### 系統總覽圖

```
┌─────────────────────────────────────────────────────────────┐
│                    MENU002 系統架構                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │                 用戶界面層 (GUI)                     │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    主窗口 (main window)                         │ │    │
│  │  │    ├── 控件 (Labels, Buttons, Entries)         │ │    │
│  │  │    ├── 工作區 (Workspaces)                      │ │    │
│  │  │    ├── 彈出窗口 (Popups)                        │ │    │
│  │  │    └── 自適應佈局 (Responsive Layout)          │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │              指令處理層 (Core Engine)               │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    指令解析器 (Command Parser)                  │ │    │
│  │  │    ├── 語法分析                                │ │    │
│  │  │    ├── 參數提取                                │ │    │
│  │  │    └── 指令註冊系統                            │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  │                                                         │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    指令處理器 (Command Handlers)               │ │    │
│  │  │    ├── Window管理                              │ │    │
│  │  │    ├── Control創建                             │ │    │
│  │  │    ├── Layout佈局                              │ │    │
│  │  │    ├── API調用                                 │ │    │
│  │  │    └── Event綁定                               │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │               工具服務層 (Utils)                    │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    通用工具 (helpers.py)                        │ │    │
│  │  │    ├── 參數解析                                │ │    │
│  │  │    ├── 路徑處理                                │ │    │
│  │  │    └── 數據驗證                                │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  │                                                         │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    日誌系統 (logger.py)                         │ │    │
│  │  │    ├── 分級日誌                                │ │    │
│  │  │    ├── 錯誤追蹤                                │ │    │
│  │  │    └── 性能監控                                │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  │                                                         │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    常量定義 (constants.py)                      │ │    │
│  │  │    ├── 系統常量                                │ │    │
│  │  │    ├── UI常量                                  │ │    │
│  │  │    └── 配置常量                                │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │               配置管理層 (Config)                   │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    默認配置 (default_config.json)               │ │    │
│  │  │    ├── 系統設定                                │ │    │
│  │  │    ├── UI主題                                  │ │    │
│  │  │    └── API配置                                 │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │               數據輸入層 (.menu腳本)                │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │    指令腳本 (demo.menu, workspace_demo.menu)    │ │    │
│  │  │    ├── 聲明式語法                              │ │    │
│  │  │    ├── 參數化配置                              │ │    │
│  │  │    └── 事件驅動                                │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 模組責任劃分

#### 1. **core/** - 核心引擎 (6個模組)
- **command_registry.py** (註冊系統)
  - 指令動態註冊
  - 工廠模式實現
  - 插件擴展接口

- **language_manager.py** (多語言)
  - 文字本地化
  - 動態語言切換
  - 資源文件管理

- **api_manager.py** (API管理)
  - 模擬HTTP請求
  - 真實API集成
  - 連接池管理

- **menu_app.py** (主應用)
  - Tkinter應用管理
  - 事件循環處理
  - 資源清理

- **command_handlers.py** (指令處理器 - 1456行)
  - 所有GUI指令實現
  - 事件處理邏輯
  - 狀態管理

- **ui_components.py** (UI組件)
  - 自定義控件
  - 表情符號選擇器
  - 佈局組件

#### 2. **utils/** - 工具服務 (4個模組)
- **helpers.py** - 通用工具函數
- **logger.py** - 日誌系統
- **constants.py** - 常量定義
- **__init__.py** - 模組初始化

#### 3. **config/** - 配置管理
- **default_config.json** - 默認配置
- **__init__.py** - 配置加載

#### 4. **tests/** - 測試文件
- 單元測試
- 集成測試

#### 5. **examples/** - 示例文件 (7個演示)
- 基礎功能演示
- 高級功能展示
- 測試案例

## 🚀 目標架構 (v3.0.0) - AI與動畫擴展

### 系統總覽圖 (含插件系統)

```
┌─────────────────────────────────────────────────────────────────┐
│                   MENU002 AI桌面助手系統                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                🎭 桌面精靈層 (Assistant)                    │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │   🤖 AI助手核心 (ai/)                                    │ │ │
│  │  │   ├── 小型語言模型                                      │ │ │
│  │  │   ├── RAG檢索系統                                      │ │ │
│  │  │   └── 對話引擎                                          │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │   🎬 動畫系統 (animation/)                               │ │ │
│  │  │   ├── 精靈動畫引擎                                      │ │ │
│  │  │   ├── 行為邏輯                                          │ │ │
│  │  │   └── 視覺效果                                          │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │   🔊 音頻處理 (audio/)                                  │ │ │
│  │  │   ├── 語音合成                                          │ │ │
│  │  │   ├── 語音識別                                          │ │ │
│  │  │   └── 音頻處理                                          │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │   📚 知識管理 (knowledge/)                              │ │ │
│  │  │   ├── 知識庫系統                                        │ │ │
│  │  │   ├── RAG檢索引擎                                      │ │ │
│  │  │   └── 數據持久化                                        │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                🔌 插件系統 (Plugins)                        │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │   插件管理器 (Plugin Manager)                           │ │ │
│  │  │   ├── 插件加載                                          │ │ │
│  │  │   ├── 生命週期管理                                      │ │ │
│  │  │   ├── 依賴解決                                          │ │ │
│  │  │   └── 安全沙箱                                          │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │   插件接口 (Plugin Interfaces)                          │ │ │
│  │  │   ├── UI插件                                            │ │ │
│  │  │   ├── AI插件                                            │ │ │
│  │  │   ├── 工具插件                                          │ │ │
│  │  │   └── 自定義插件                                        │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                ⚙️ 核心引擎層 (Core v3.0)                   │ │
│  │  [原有 core/ 模組 + 增強功能]                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                🛠️ 工具服務層 (Utils v3.0)                  │ │
│  │  [原有 utils/ 模組 + AI/動畫工具]                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                ⚙️ 配置與數據層                             │ │
│  │  [config/ + knowledge/ + 插件配置]                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 新增模組詳細設計

#### 🤖 **ai/** - AI智能模組
```
ai/
├── __init__.py          # 模組初始化
├── model.py            # 小型語言模型 (輕量化)
│   ├── 模型加載
│   ├── 推理引擎
│   └── 資源管理
├── rag.py              # RAG檢索系統
│   ├── 知識庫索引
│   ├── 檢索算法
│   └── 結果排序
├── dialogue.py         # 對話引擎
│   ├── 自然語言處理
│   ├── 對話狀態管理
│   └── 上下文理解
└── intent.py           # 意圖識別
    ├── 用戶意圖分析
    ├── 動作映射
    └── 響應生成
```

#### 🎬 **animation/** - 動畫系統模組
```
animation/
├── __init__.py         # 模組初始化
├── sprite.py           # 精靈動畫引擎
│   ├── 精靈渲染
│   ├── 動畫狀態機
│   └── 性能優化
├── behavior.py         # 行為邏輯
│   ├── 移動算法
│   ├── 互動邏輯
│   └── 狀態轉換
├── effects.py          # 視覺效果
│   ├── 粒子系統
│   ├── 過渡動畫
│   └── 特效渲染
└── physics.py          # 物理模擬
    ├── 重力模擬
    ├── 碰撞檢測
    └── 運動學
```

#### 🔊 **audio/** - 音頻處理模組
```
audio/
├── __init__.py         # 模組初始化
├── speech.py           # 語音合成 (TTS)
│   ├── 文本轉語音
│   ├── 語音優化
│   └── 多語種支持
├── recognition.py      # 語音識別 (STT)
│   ├── 實時識別
│   ├── 噪音過濾
│   └── 精確率優化
├── audio.py            # 通用音頻處理
│   ├── 音頻播放
│   ├── 音量控制
│   └── 格式轉換
└── effects.py          # 音頻效果
    ├── 回聲處理
    ├── 等級壓縮
    └── 空間音頻
```

#### 📚 **knowledge/** - 知識管理模組
```
knowledge/
├── __init__.py         # 模組初始化
├── library.py          # 知識庫系統
│   ├── 文檔存儲
│   ├── 元數據管理
│   └── 版本控制
├── search.py           # RAG檢索引擎
│   ├── 語義搜索
│   ├── 相關性排序
│   └── 查詢優化
├── storage.py          # 數據持久化
│   ├── 本地存儲
│   ├── 雲端同步
│   └── 備份恢復
└── import_export.py    # 數據導入導出
    ├── 多格式支持
    ├── 批量處理
    └── 數據驗證
```

#### 🔌 **plugins/** - 插件系統 (未來擴展)
```
plugins/
├── __init__.py         # 插件系統初始化
├── manager.py          # 插件管理器
│   ├── 插件發現
│   ├── 動態加載
│   └── 生命週期管理
├── interfaces.py       # 插件接口定義
│   ├── UI插件接口
│   ├── AI插件接口
│   ├── 工具插件接口
│   └── 自定義接口
├── sandbox.py          # 安全沙箱
│   ├── 權限控制
│   ├── 資源限制
│   └── 隔離執行
└── marketplace.py      # 插件市場
    ├── 插件倉庫
    ├── 安裝管理
    └── 更新機制
```

## 🔄 系統工作流程

### 基礎GUI流程
```
1. 腳本解析 → 2. 指令註冊 → 3. UI創建 → 4. 事件綁定 → 5. 應用運行
    ↓              ↓              ↓            ↓              ↓
.menu文件     command_handlers  menu_app    Tkinter事件    main.py
```

### AI助手流程 (v3.0)
```
1. 用戶輸入 → 2. 意圖識別 → 3. RAG查詢 → 4. AI推理 → 5. 動畫響應 → 6. 語音輸出
    ↓             ↓             ↓           ↓            ↓             ↓
對話界面       ai/intent.py   knowledge/   ai/model.py   animation/    audio/
```

## 📊 模組依賴關係

### 當前依賴 (v2.1.0)
```
main.py
├── core/menu_app.py
│   ├── core/command_handlers.py
│   │   ├── utils/helpers.py
│   │   ├── utils/logger.py
│   │   └── config/
│   ├── core/ui_components.py
│   └── utils/constants.py
├── core/language_manager.py
└── core/api_manager.py
```

### 目標依賴 (v3.0.0)
```
main.py
├── assistant/ (新層)
│   ├── ai/
│   │   ├── knowledge/ (讀取)
│   │   └── audio/ (語音輸出)
│   ├── animation/
│   │   └── audio/ (音效)
│   └── plugins/ (可選)
├── core/ (增強)
│   ├── ai/ (配置)
│   ├── animation/ (集成)
│   └── plugins/ (支持)
└── utils/ (擴展)
    ├── ai/ (工具)
    └── animation/ (工具)
```

## 🎯 設計原則

### 架構原則
1. **模組化** - 各模組職責單一，接口清晰
2. **統一參數化** - 全系統使用一致的參數格式和命名規範
3. **可擴展** - 插件系統支持功能擴展
4. **輕量化** - 資源使用優化，避免性能問題
5. **可維護** - 代碼結構清晰，易於理解和修改

### 參數化原則
1. **統一命名** - 位置(x,y,width,height)、顏色(bg,color)、字體(font)等參數在所有指令中保持一致
2. **跨指令共用** - 參數格式標準化，讓子GUI、工作區、按鍵等指令都能使用相同參數
3. **配置驅動** - 支持參數配置和主題系統，便於批量修改和主題切換
4. **向後兼容** - 保持現有語法兼容，逐步遷移到統一參數系統

### 色彩設計原則 (待實現)
1. **豐富色彩** - 超越黑白單色，支援完整色彩空間
2. **主題系統** - 預設主題 + 自定義主題 + 動態切換
3. **漸層支持** - 支援色彩漸層和透明度控制
4. **一致性** - 全系統色彩設計保持視覺一致性

### 依賴原則
1. **單向依賴** - 高層模組依賴低層，低層不依賴高層
2. **接口隔離** - 通過接口而非具體實現進行依賴
3. **依賴注入** - 運行時動態注入依賴，便於測試

### 性能原則
1. **懶加載** - 非必需模組按需加載
2. **資源池** - 重用資源，避免頻繁創建銷毀
3. **異步處理** - 耗時操作異步執行，不阻塞UI

## 🚀 遷移計劃

### v2.1.0 → v2.5.0 (架構優化)
- [ ] 重構核心模組，提取共用邏輯
- [ ] 建立插件架構基礎
- [ ] 增強配置系統
- [ ] 優化資源管理

### v2.5.0 → v3.0.0 (AI與動畫擴展)
- [ ] 建立新模組目錄結構
- [ ] 實現AI模型集成
- [ ] 開發動畫系統
- [ ] 建立知識庫系統
- [ ] 集成插件系統

### v3.0.0 → v4.0.0 (終極助手)
- [ ] 完善AI助手行為
- [ ] 實現完整對話系統
- [ ] 開發插件生態
- [ ] 優化用戶體驗

---

*本文檔將隨架構演進持續更新*